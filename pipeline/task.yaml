apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: fitness-build-container
  namespace: kplogesh-dev
spec:
  params:
    - default: 'https://github.com/kplogesh/openshift.git'
      description: Repository URL
      name: REPO_URL
      type: string
    - default: 'msr-test'
      description: 'MSR Test'
      name: IMAGE_NAME
      type: string
    - default: latest
      description: 'Image Tag'
      name: IMAGE_TAG
      type: string
    - default: default
      description: 'Namespace'
      name: NAMESPACE
      type: string
  steps:
    - name: git-source
      image: alpine/git
      script: |
        git clone --recursive $(inputs.params.REPO_URL) /workspace/source
        ls -l /workspace/source/buildconfig
    - name: create-fitness-buildconfig
      image: openshift/origin-cli
      script: |
        cd /workspace/source
        if oc get imagestream fitness-msr -n $(inputs.params.NAMESPACE) &> /dev/null; then
          echo "ImageStream 'fitness-msr' already exists. Skipping creation."
        else
          echo "ImageStream 'fitness-msr' does not exist. Creating..."
          oc create -f pipeline/imagestream.yaml -n $(inputs.params.NAMESPACE)
        fi

        if oc get buildconfig fitness-buildconfig -n $(inputs.params.NAMESPACE) &> /dev/null; then
          echo "BuildConfig 'fitness-buildconfig' already exists. Skipping creation."
        else
          echo "BuildConfig 'fitness-buildconfig' does not exist. Creating..."
          oc create -f pipeline/buildconfig.yaml -n $(inputs.params.NAMESPACE)
        fi
    - name: apply-fitness-buildconfig
      image: openshift/origin-cli
      script: |
        cd /workspace/source
        # Apply the ImageStream configuration
        # oc apply -f buildconfig/image-stream.yaml
        oc apply set-last-applied -f buildconfig/imagestream.yaml --create-annotation=true -n $(inputs.params.NAMESPACE)

        # Apply the BuildConfig configuration
        oc apply set-last-applied -f buildconfig/buildconfig.yaml --create-annotation=true -n $(inputs.params.NAMESPACE)
    - name: start-fitness-build 
      image: openshift/origin-cli
      script: |
        cd /workspace/source
        oc start-build fitness-buildconfig